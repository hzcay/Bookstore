<!DOCTYPE html>
<html
     xmlns:th="http://www.thymeleaf.org"
     th:replace="~{fragments/layout :: base(~{::div[@data-content]}, ~{::link[@data-extra='css']}, ~{::script[@data-extra='js']})}"
>
     <!-- Đây là CSS riêng của trang stock, sẽ được layout chèn vào <head> -->
     <link data-extra="css" rel="stylesheet" th:href="@{/css/warehouse-stock.css}" />
     
     <!-- JavaScript riêng của trang -->
     <script data-extra="js">
          // Load employee name into page header
          document.addEventListener('DOMContentLoaded', async function() {
               try {
                    const response = await fetch('/api/v1/auth/session');
                    const data = await response.json();
                    if (data.authenticated && data.userName) {
                         const headerNameEl = document.getElementById('header-employee-name');
                         if (headerNameEl) {
                              headerNameEl.textContent = data.userName;
                         }
                    }
               } catch (error) {
                    console.error('Error loading employee name:', error);
               }
          });
     </script>

     <div data-content class="page-stock">
          <!-- Professional Warehouse Header -->
          <div class="warehouse-header mb-4">
               <div
                    class="card border-0 shadow-lg"
                    style="
                         background: linear-gradient(135deg, #1976d2 0%, #0d47a1 100%);
                         border-radius: 15px;
                    "
               >
                    <div class="card-body p-4">
                         <div class="row align-items-center">
                              <div class="col-md-8">
                                   <div class="d-flex align-items-center mb-2">
                                        <div
                                             class="icon-box me-3"
                                             style="
                                                  background: rgba(255, 255, 255, 0.2);
                                                  padding: 15px;
                                                  border-radius: 12px;
                                             "
                                        >
                                             <i
                                                  class="bi bi-box-seam"
                                                  style="font-size: 2.5rem; color: white"
                                             ></i>
                                        </div>
                                        <div>
                                             <h2 class="text-white mb-1 fw-bold">
                                                  <i class="bi bi-building"></i> QUẢN LÝ TỒN KHO
                                             </h2>
                                             <p class="text-white mb-0 opacity-75">
                                                  <i class="bi bi-calendar3"></i>
                                                  <span
                                                       th:text="${#temporals.format(#temporals.createNow(), 'EEEE, dd/MM/yyyy', new java.util.Locale('vi'))}"
                                                       >Thứ Sáu, 18/10/2025</span
                                                  >
                                                  &nbsp;|&nbsp;
                                                  <i class="bi bi-person-badge"></i> <span id="header-employee-name">Nhân viên kho</span>
                                             </p>
                                        </div>
                                   </div>
                              </div>
                         </div>
                    </div>
               </div>
          </div>

          <!-- KPI Cards Row -->
          <div class="row g-3 mb-4 kpi-row">
               <div class="col-md-3">
                    <div class="card card-kpi">
                         <div class="card-body">
                              <div class="d-flex justify-content-between align-items-start">
                                   <div class="flex-grow-1">
                                        <div class="text-muted mb-2 small">
                                             <i class="bi bi-book me-1"></i> TỔNG SỐ ĐẦU SÁCH
                                        </div>
                                        <h4 class="mb-2" th:text="${totalBooks} ?: 0">0</h4>
                                        <div class="small text-success">
                                             <i class="bi bi-graph-up-arrow"></i>
                                             <span
                                                  th:text="${deltaBooksText} ?: '+0% so với tháng trước'"
                                                  >+0%</span
                                             >
                                        </div>
                                   </div>
                                   <div class="kpi-icon">
                                        <i class="bi bi-book-fill"></i>
                                   </div>
                              </div>
                         </div>
                    </div>
               </div>
               <div class="col-md-3">
                    <div class="card card-kpi">
                         <div class="card-body">
                              <div class="d-flex justify-content-between align-items-start">
                                   <div class="flex-grow-1">
                                        <div class="text-muted mb-2 small">
                                             <i class="bi bi-boxes me-1"></i> TỔNG SỐ LƯỢNG
                                        </div>
                                        <h4 class="mb-2" th:text="${totalQuantity} ?: 0">0</h4>
                                        <div class="small text-success">
                                             <i class="bi bi-graph-up-arrow"></i>
                                             <span
                                                  th:text="${deltaQtyText} ?: '+0% so với tháng trước'"
                                                  >+0%</span
                                             >
                                        </div>
                                   </div>
                                   <div class="kpi-icon">
                                        <i class="bi bi-boxes"></i>
                                   </div>
                              </div>
                         </div>
                    </div>
               </div>
               <div class="col-md-3">
                    <div class="card card-kpi">
                         <div class="card-body">
                              <div class="d-flex justify-content-between align-items-start">
                                   <div class="flex-grow-1">
                                        <div class="text-muted mb-2 small">
                                             <i class="bi bi-exclamation-triangle me-1"></i> SẮP HẾT
                                             HÀNG
                                        </div>
                                        <h4 class="mb-2" th:text="${lowStockCount} ?: 0">0</h4>
                                        <div
                                             class="small"
                                             th:classappend="${lowStockCount > 0} ? 'text-danger' : 'text-success'"
                                        >
                                             <i
                                                  th:class="${lowStockCount > 0} ? 'bi bi-arrow-down-circle' : 'bi bi-check-circle'"
                                             ></i>
                                             <span
                                                  th:text="${lowStockCount > 0} ? 'Cần nhập thêm' : 'Kho ổn định'"
                                                  >Cần nhập thêm</span
                                             >
                                        </div>
                                   </div>
                                   <div class="kpi-icon">
                                        <i class="bi bi-exclamation-triangle-fill"></i>
                                   </div>
                              </div>
                         </div>
                    </div>
               </div>
               <div class="col-md-3">
                    <div class="card card-kpi">
                         <div class="card-body">
                              <div class="d-flex justify-content-between align-items-start">
                                   <div class="flex-grow-1">
                                        <div class="text-muted mb-2 small">
                                             <i class="bi bi-wallet2 me-1"></i> GIÁ TRỊ TỒN KHO
                                        </div>
                                        <h5 class="mb-2" th:text="${inventoryValueFmt} ?: '0 VNĐ'">
                                             0 VNĐ
                                        </h5>
                                        <div class="small text-info">
                                             <i class="bi bi-cash-stack"></i> Tổng vốn
                                        </div>
                                   </div>
                                   <div class="kpi-icon">
                                        <i class="bi bi-currency-dollar"></i>
                                   </div>
                              </div>
                         </div>
                    </div>
               </div>
          </div>

          <!-- Bộ lọc -->
          <div class="d-flex justify-content-between align-items-center mb-2">
               <form class="d-flex gap-2" method="get" th:action="@{/warehouse/stock}">
                    <input
                         class="form-control"
                         style="min-width: 280px"
                         type="text"
                         name="keyword"
                         placeholder="Tìm kiếm sách..."
                         th:value="${keyword}"
                    />
                    <select class="form-select" name="category">
                         <option value="">Tất cả danh mục</option>
                         <option
                              th:each="c : ${categories}"
                              th:value="${c.categoryId}"
                              th:text="${c.name}"
                              th:selected="${c.categoryId} == ${category}"
                         >
                              Danh mục
                         </option>
                    </select>
                    <select class="form-select" name="size">
                         <option th:value="10" th:selected="${size} == 10">10 / trang</option>
                         <option th:value="20" th:selected="${size} == 20">20 / trang</option>
                         <option th:value="50" th:selected="${size} == 50">50 / trang</option>
                    </select>
                    <button class="btn btn-outline-secondary" aria-label="Lọc kết quả">
                         <i class="bi bi-funnel"></i> Lọc
                    </button>
               </form>
          </div>

          <!-- Bảng -->
          <div class="table-container">
               <div class="table-responsive">
                    <table class="table align-middle mb-0">
                         <thead>
                              <tr>
                                   <th class="ps-4 text-dark fw-bold fs-6">Mã sách</th>
                                   <th class="text-dark fw-bold fs-6">Tên sách</th>
                                   <th class="text-dark fw-bold fs-6">Tác giả</th>
                                   <th class="text-dark fw-bold fs-6">Danh mục</th>
                                   <th class="text-end text-dark fw-bold fs-6">Số lượng</th>
                                   <th class="text-end text-dark fw-bold fs-6">Giá</th>
                                   <th class="text-center text-dark fw-bold fs-6">Trạng thái</th>
                                   <th class="text-center text-dark fw-bold fs-6">Chi tiết</th>
                              </tr>
                         </thead>
                         <tbody>
                              <tr th:each="r : ${data}">
                                   <td class="ps-4" th:text="${r.bookId}">BK001</td>
                                   <td><div th:text="${r.title}">Đắc Nhân Tâm</div></td>
                                   <td th:text="${r.authorName} ?: '—'">—</td>
                                   <td>
                                        <span
                                             class="badge badge-soft"
                                             th:text="${r.categoryName} ?: '—'"
                                             >—</span
                                        >
                                   </td>
                                   <td
                                        class="text-end fw-semibold"
                                        th:text="${#numbers.formatInteger(r.stock, 0)}"
                                   >
                                        0
                                   </td>
                                   <td class="text-end" th:text="${r.priceFmt} ?: '—'">—</td>
                                   <td class="text-center">
                                        <span th:if="${r.stock > 10}" class="badge badge-ok"
                                             >Còn hàng</span
                                        >
                                        <span th:if="${r.stock <= 10}" class="badge badge-warn"
                                             >Sắp hết</span
                                        >
                                   </td>

                                   <!-- CỘT CHI TIẾT - CHO CẢ ADMIN VÀ NHÂN VIÊN -->
                                   <td class="text-center">
                                        <a
                                             class="btn btn-sm btn-outline-primary"
                                             title="Xem chi tiết và sửa số lượng (nếu là Admin)"
                                             th:href="@{/warehouse/stock/view/{id}(id=${r.bookId})}"
                                        >
                                             <i class="bi bi-eye me-1"></i>
                                             <span th:if="${isAdmin}">Xem & Sửa</span>
                                             <span th:unless="${isAdmin}">Xem</span>
                                        </a>
                                   </td>
                              </tr>
                              <tr th:if="${#lists.isEmpty(data)}">
                                   <td class="text-center py-4" colspan="8">Không có dữ liệu</td>
                              </tr>
                         </tbody>
                    </table>
               </div>

               <!-- Pagination -->
               <div class="d-flex justify-content-between align-items-center p-3">
                    <div
                         class="text-muted small"
                         th:text="'Hiển thị ' + ${#lists.size(data)} + ' / ' + ${totalBooks} + ' đầu sách'"
                    >
                         Hiển thị
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                         <div></div>
                         <div class="btn-group">
                              <a
                                   class="btn btn-outline-secondary"
                                   th:classappend="${page<=0}? 'disabled'"
                                   th:href="@{/warehouse/stock(page=${page-1}, size=${size}, keyword=${keyword}, category=${category})}"
                                   >Trước</a
                              >
                              <span class="btn btn-outline-secondary disabled" th:text="${page+1}"
                                   >1</span
                              >
                              <a
                                   class="btn btn-outline-secondary"
                                   th:classappend="${last}? 'disabled'"
                                   th:href="@{/warehouse/stock(page=${page+1}, size=${size}, keyword=${keyword}, category=${category})}"
                                   >Sau</a
                              >
                         </div>
                    </div>
               </div>
          </div>

          <!-- Modal và form thêm sách đã bị xóa - chỉ Admin mới được thêm/sửa/xóa sách -->

          <!-- JavaScript không cần thiết cho trang read-only -->
     </div>
</html>
