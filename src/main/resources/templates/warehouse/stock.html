<!DOCTYPE html>
<html
     xmlns:th="http://www.thymeleaf.org"
     th:replace="~{fragments/layout :: base(~{::div[@data-content]}, ~{::link[@data-extra='css']})}"
>
     <!-- Đây là CSS riêng của trang stock, sẽ được layout chèn vào <head> -->
     <link data-extra="css" rel="stylesheet" th:href="@{/css/warehouse-stock.css}" />

     <div data-content class="page-stock">
          <!-- KPI -->
          <div class="row g-3 mb-3">
               <div class="col-md-3">
                    <div class="card card-kpi p-3">
                         <div class="d-flex justify-content-between align-items-center">
                              <div>
                                   <div class="text-muted">Tổng số đầu sách</div>
                                   <div class="h4 mb-0" th:text="${totalBooks} ?: 0">0</div>
                                   <div
                                        class="small text-success mt-1"
                                        th:text="${deltaBooksText} ?: '+0% so với tháng trước'"
                                   >
                                        +0%
                                   </div>
                              </div>
                              <span class="badge badge-soft"><i class="bi bi-book"></i></span>
                         </div>
                    </div>
               </div>
               <div class="col-md-3">
                    <div class="card card-kpi p-3">
                         <div class="d-flex justify-content-between align-items-center">
                              <div>
                                   <div class="text-muted">Tổng số lượng</div>
                                   <div class="h4 mb-0" th:text="${totalQuantity} ?: 0">0</div>
                                   <div
                                        class="small text-success mt-1"
                                        th:text="${deltaQtyText} ?: '+0% so với tháng trước'"
                                   >
                                        +0%
                                   </div>
                              </div>
                              <span class="badge badge-soft"><i class="bi bi-boxes"></i></span>
                         </div>
                    </div>
               </div>
               <div class="col-md-3">
                    <div class="card card-kpi p-3">
                         <div class="d-flex justify-content-between align-items-center">
                              <div>
                                   <div class="text-muted">Sắp hết hàng</div>
                                   <div class="h4 mb-0" th:text="${lowStockCount} ?: 0">0</div>
                                   <div class="small text-danger mt-1">Cần nhập thêm</div>
                              </div>
                              <span class="badge badge-soft"
                                   ><i class="bi bi-exclamation-triangle"></i
                              ></span>
                         </div>
                    </div>
               </div>
               <div class="col-md-3">
                    <div class="card card-kpi p-3">
                         <div class="d-flex justify-content-between align-items-center">
                              <div>
                                   <div class="text-muted">Giá trị tồn kho</div>
                                   <div class="h4 mb-0" th:text="${inventoryValueFmt} ?: '0 VND'">
                                        0 VND
                                   </div>
                              </div>
                              <span class="badge badge-soft"><i class="bi bi-receipt"></i></span>
                         </div>
                    </div>
               </div>
          </div>

          <!-- Bộ lọc -->
          <div class="d-flex justify-content-between align-items-center mb-2">
               <form class="d-flex gap-2" method="get" th:action="@{/warehouse/stock}">
                    <input
                         class="form-control"
                         style="min-width: 280px"
                         type="text"
                         name="keyword"
                         placeholder="Tìm kiếm sách..."
                         th:value="${keyword}"
                    />
                    <select class="form-select" name="category">
                         <option value="">Tất cả danh mục</option>
                         <option
                              th:each="c : ${categories}"
                              th:value="${c.categoryId}"
                              th:text="${c.name}"
                              th:selected="${c.categoryId} == ${category}"
                         >
                              Danh mục
                         </option>
                    </select>
                    <select class="form-select" name="size">
                         <option th:value="10" th:selected="${size} == 10">10 / trang</option>
                         <option th:value="20" th:selected="${size} == 20">20 / trang</option>
                         <option th:value="50" th:selected="${size} == 50">50 / trang</option>
                    </select>
                    <button class="btn btn-outline-secondary" aria-label="Lọc kết quả">
                         <i class="bi bi-funnel"></i> Lọc
                    </button>
               </form>
          </div>

          <!-- Bảng -->
          <div class="card card-kpi p-0">
               <div class="table-responsive">
                    <table class="table align-middle mb-0">
                         <thead>
                              <tr>
                                   <th class="ps-4">Mã sách</th>
                                   <th>Tên sách</th>
                                   <th>Tác giả</th>
                                   <th>Danh mục</th>
                                   <th class="text-end">Số lượng</th>
                                   <th class="text-end">Giá</th>
                                   <th class="text-center">Trạng thái</th>
                                   <th class="text-center">Thao tác</th>
                              </tr>
                         </thead>
                         <tbody>
                              <tr th:each="r : ${data}">
                                   <td class="ps-4" th:text="${r.bookId}">BK001</td>
                                   <td><div th:text="${r.title}">Đắc Nhân Tâm</div></td>
                                   <td th:text="${r.authorName} ?: '—'">—</td>
                                   <td>
                                        <span
                                             class="badge badge-soft"
                                             th:text="${r.categoryName} ?: '—'"
                                             >—</span
                                        >
                                   </td>
                                   <td
                                        class="text-end fw-semibold"
                                        th:text="${#numbers.formatInteger(r.stock, 0)}"
                                   >
                                        0
                                   </td>
                                   <td class="text-end" th:text="${r.priceFmt} ?: '—'">—</td>
                                   <td class="text-center">
                                        <span th:if="${r.stock > 10}" class="badge badge-ok"
                                             >Còn hàng</span
                                        >
                                        <span th:if="${r.stock <= 10}" class="badge badge-warn"
                                             >Sắp hết</span
                                        >
                                   </td>
                                   <td class="text-center">
                                        <a class="btn-ghost" title="Xem"
                                             ><i class="bi bi-eye"></i
                                        ></a>
                                        <a class="btn-ghost" title="Sửa"
                                             ><i class="bi bi-pencil"></i
                                        ></a>
                                        <a class="btn-ghost" title="Xóa"
                                             ><i class="bi bi-trash"></i
                                        ></a>
                                   </td>
                              </tr>
                              <tr th:if="${#lists.isEmpty(data)}">
                                   <td class="text-center py-4" colspan="8">Không có dữ liệu</td>
                              </tr>
                         </tbody>
                    </table>
               </div>

               <!-- Pagination -->
               <div class="d-flex justify-content-between align-items-center p-3">
                    <div
                         class="text-muted small"
                         th:text="'Hiển thị ' + ${#lists.size(data)} + ' / ' + ${totalBooks} + ' đầu sách'"
                    >
                         Hiển thị
                    </div>
                    <div class="d-flex align-items-center gap-2">
                         <button
                              type="button"
                              class="btn btn-primary"
                              data-bs-toggle="modal"
                              data-bs-target="#modalCreateBook"
                         >
                              <i class="bi bi-plus-lg me-1"></i> Thêm sách
                         </button>
                         <div class="btn-group">
                              <a
                                   class="btn btn-outline-secondary"
                                   th:classappend="${page<=0}? 'disabled'"
                                   th:href="@{/warehouse/stock(page=${page-1}, size=${size}, keyword=${keyword}, category=${category})}"
                                   >Trước</a
                              >
                              <span class="btn btn-outline-secondary disabled" th:text="${page+1}"
                                   >1</span
                              >
                              <a
                                   class="btn btn-outline-secondary"
                                   th:classappend="${last}? 'disabled'"
                                   th:href="@{/warehouse/stock(page=${page+1}, size=${size}, keyword=${keyword}, category=${category})}"
                                   >Sau</a
                              >
                         </div>
                    </div>
               </div>
          </div>

          <!-- Modal: Thêm sách -->
          <div class="modal fade" id="modalCreateBook" tabindex="-1" aria-hidden="true">
               <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                         <div class="modal-header">
                              <h5 class="modal-title">Thêm sách mới</h5>
                              <button
                                   type="button"
                                   class="btn-close"
                                   data-bs-dismiss="modal"
                                   aria-label="Close"
                              ></button>
                         </div>
                         <form
                              id="formCreateBook"
                              th:action="@{/warehouse/stock/books}"
                              method="post"
                         >
                              <div class="modal-body">
                                   <div class="row g-3">
                                        <div class="col-md-6">
                                             <label class="form-label">Tên sách</label>
                                             <input class="form-control" name="title" required />
                                        </div>
                                        <div class="col-md-6">
                                             <label class="form-label">Thể loại</label>
                                             <div class="d-flex gap-2">
                                                  <select
                                                       class="form-select"
                                                       name="categoryId"
                                                       required
                                                  >
                                                       <option value="">-- Chọn thể loại --</option>
                                                       <option
                                                            th:each="c : ${categories}"
                                                            th:value="${c.categoryId}"
                                                            th:text="${c.name}"
                                                       ></option>
                                                  </select>
                                                  <button
                                                       type="button"
                                                       class="btn btn-outline-secondary"
                                                       title="Thêm thể loại"
                                                       data-bs-toggle="collapse"
                                                       data-bs-target="#collapseCreateCategory"
                                                       aria-expanded="false"
                                                       aria-controls="collapseCreateCategory"
                                                  >
                                                       <i class="bi bi-plus-lg"></i>
                                                  </button>
                                             </div>
                                             <div class="collapse mt-2" id="collapseCreateCategory">
                                                  <div class="row g-2">
                                                       <div class="col-8">
                                                            <input
                                                                 class="form-control"
                                                                 id="newCategoryName"
                                                                 name="newCategoryName"
                                                                 placeholder="Tên thể loại"
                                                                 form="formCreateCategory"
                                                                 required
                                                            />
                                                       </div>
                                                       <div class="col-4 d-grid">
                                                            <button
                                                                 class="btn btn-primary"
                                                                 type="submit"
                                                                 form="formCreateCategory"
                                                            >
                                                                 Thêm thể loại
                                                            </button>
                                                       </div>
                                                  </div>
                                             </div>
                                        </div>
                                        <div class="col-md-6">
                                             <label class="form-label">Tác giả</label>
                                             <div class="d-flex gap-2">
                                                  <select
                                                       class="form-select"
                                                       name="authorId"
                                                       required
                                                  >
                                                       <option value="">-- Chọn tác giả --</option>
                                                       <option
                                                            th:each="a : ${authors}"
                                                            th:value="${a.authorId}"
                                                            th:text="${a.name}"
                                                       ></option>
                                                  </select>
                                                  <button
                                                       type="button"
                                                       class="btn btn-outline-secondary"
                                                       title="Thêm tác giả"
                                                       data-bs-toggle="collapse"
                                                       data-bs-target="#collapseCreateAuthor"
                                                       aria-expanded="false"
                                                       aria-controls="collapseCreateAuthor"
                                                  >
                                                       <i class="bi bi-plus-lg"></i>
                                                  </button>
                                             </div>
                                             <div class="collapse mt-2" id="collapseCreateAuthor">
                                                  <div class="row g-2">
                                                       <div class="col-6">
                                                            <input
                                                                 class="form-control"
                                                                 id="newAuthorName"
                                                                 name="newAuthorName"
                                                                 placeholder="Tên tác giả"
                                                                 form="formCreateAuthor"
                                                                 required
                                                            />
                                                       </div>
                                                       <div class="col-6">
                                                            <input
                                                                 class="form-control"
                                                                 id="newAuthorDescription"
                                                                 name="newAuthorDescription"
                                                                 placeholder="Mô tả"
                                                                 form="formCreateAuthor"
                                                            />
                                                       </div>
                                                       <div class="col-12 d-grid">
                                                            <button
                                                                 class="btn btn-primary"
                                                                 type="submit"
                                                                 form="formCreateAuthor"
                                                            >
                                                                 Thêm tác giả
                                                            </button>
                                                       </div>
                                                  </div>
                                             </div>
                                        </div>
                                        <div class="col-md-6">
                                             <label class="form-label">NXB</label>
                                             <select
                                                  class="form-select"
                                                  name="publisherId"
                                                  required
                                             >
                                                  <option value="">-- Chọn NXB --</option>
                                                  <option
                                                       th:each="p : ${publishers}"
                                                       th:value="${p.publisherId}"
                                                       th:text="${p.name}"
                                                  ></option>
                                             </select>
                                        </div>
                                        <div class="col-md-6">
                                             <label class="form-label">Giá nhập</label>
                                             <input
                                                  class="form-control"
                                                  type="number"
                                                  min="0"
                                                  step="1000"
                                                  name="importPrice"
                                             />
                                        </div>
                                        <div class="col-md-6">
                                             <label class="form-label">Giá bán</label>
                                             <input
                                                  class="form-control"
                                                  type="number"
                                                  min="0"
                                                  step="1000"
                                                  name="salePrice"
                                             />
                                        </div>
                                   </div>
                              </div>
                              <div class="modal-footer">
                                   <button
                                        type="button"
                                        class="btn btn-light"
                                        data-bs-dismiss="modal"
                                   >
                                        Hủy
                                   </button>
                                   <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-plus-lg me-1"></i> Thêm sách
                                   </button>
                              </div>
                         </form>
                    </div>
               </div>
          </div>

          <!-- Form ẩn: Thêm thể loại -->
          <form
               id="formCreateCategory"
               th:action="@{/warehouse/stock/categories}"
               method="post"
               style="display: none"
          >
               <input type="hidden" name="name" id="categoryNameHidden" />
          </form>

          <!-- Form ẩn: Thêm tác giả -->
          <form
               id="formCreateAuthor"
               th:action="@{/warehouse/stock/authors}"
               method="post"
               style="display: none"
          >
               <input type="hidden" name="name" id="authorNameHidden" />
               <input type="hidden" name="description" id="authorDescriptionHidden" />
          </form>

          <script>
               // Đồng bộ dữ liệu khi submit form thêm thể loại
               document
                    .getElementById("formCreateCategory")
                    .addEventListener("submit", function (e) {
                         const categoryName = document.getElementById("newCategoryName").value;
                         document.getElementById("categoryNameHidden").value = categoryName;
                    });

               // Đồng bộ dữ liệu khi submit form thêm tác giả
               document.getElementById("formCreateAuthor").addEventListener("submit", function (e) {
                    const authorName = document.getElementById("newAuthorName").value;
                    const authorDescription = document.getElementById("newAuthorDescription").value;
                    document.getElementById("authorNameHidden").value = authorName;
                    document.getElementById("authorDescriptionHidden").value = authorDescription;
               });
          </script>
     </div>
</html>
