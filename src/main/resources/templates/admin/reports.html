<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" th:replace="~{admin/layout :: layout(~{::content})}">
<head>
    <title>Báo cáo Thống kê</title>
</head>
<body>
    <div th:fragment="content">
    <h2 class="mb-4">Báo cáo Thống kê</h2>

    <div class="card mb-4">
        <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">Bộ lọc báo cáo</h6>
            </div>
            <div class="card-body">
                <form th:action="@{/admin/reports}" method="get" class="row g-3">
                <div class="col-md-4">
                        <label class="form-label">Từ ngày</label>
                        <input type="date" name="fromDate" class="form-control" th:value="${fromDate}">
                    </div>
                <div class="col-md-4">
                        <label class="form-label">Đến ngày</label>
                        <input type="date" name="toDate" class="form-control" th:value="${toDate}">
                    </div>
                <div class="col-md-4">
                        <label class="form-label">Chu kỳ</label>
                        <select name="granularity" class="form-select">
                            <option value="day" th:selected="${granularity == 'day'}">Theo ngày</option>
                            <option value="week" th:selected="${granularity == 'week'}">Theo tuần</option>
                            <option value="month" th:selected="${granularity == 'month'}">Theo tháng</option>
                        </select>
                    </div>
                <div class="col-12">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-search"></i> Xem báo cáo
                            </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="row mb-4">
        <div class="col-xl-4 col-md-6 mb-3">
            <div class="card border-left-primary shadow h-100">
                    <div class="card-body">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            Tổng Doanh thu
                        </div>
                    <div class="h5 mb-0 font-weight-bold text-gray-800"
                             th:text="${#numbers.formatDecimal(totalRevenue, 0, 'COMMA', 0, 'POINT')} + ' đ'">
                            0 đ
                        </div>
                    </div>
                </div>
            </div>

        <div class="col-xl-4 col-md-6 mb-3">
            <div class="card border-left-success shadow h-100">
                    <div class="card-body">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                            Tổng Đơn hàng
                    </div>
                    <div class="h5 mb-0 font-weight-bold text-gray-800" th:text="${totalOrders}">0</div>
                    </div>
                </div>
            </div>

        <div class="col-xl-4 col-md-6 mb-3">
            <div class="card border-left-info shadow h-100">
                    <div class="card-body">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                            Giá trị TB/Đơn
                        </div>
                    <div class="h5 mb-0 font-weight-bold text-gray-800"
                             th:text="${#numbers.formatDecimal(avgOrderValue, 0, 'COMMA', 0, 'POINT')} + ' đ'">
                            0 đ
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <div class="card mb-4" th:if="${salesReport != null && !salesReport.data.empty}">
        <div class="card-header">
            <h6 class="m-0 font-weight-bold text-primary">Biểu đồ Doanh thu</h6>
                    </div>
        <div class="card-body">
            <canvas id="revenueChart" height="80"></canvas>
                </div>
            </div>

    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">Báo cáo Tồn kho</h6>
                    </div>
                <div class="card-body" th:if="${inventoryReport != null}">
                    <table class="table table-sm">
                        <tr>
                            <th>Tổng số loại sách:</th>
                            <td th:text="${inventoryReport.totalBooks}">0</td>
                        </tr>
                        <tr>
                            <th>Tổng số lượng:</th>
                            <td th:text="${inventoryReport.totalQuantity}">0</td>
                        </tr>
                        <tr>
                            <th>Giá trị kho:</th>
                            <td th:text="${#numbers.formatDecimal(inventoryReport.totalValue, 0, 'COMMA', 0, 'POINT')} + ' đ'">0 đ</td>
                        </tr>
                        <tr>
                            <th>Số sách sắp hết:</th>
                            <td th:text="${inventoryReport.lowStockCount}">0</td>
                        </tr>
                    </table>
                    <canvas id="inventoryChart" height="150"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">Công nợ Nhà cung cấp</h6>
                    </div>
                <div class="card-body" th:if="${debtReport != null}">
                    <table class="table table-sm">
                        <tr>
                            <th>Tổng công nợ:</th>
                            <td th:text="${#numbers.formatDecimal(debtReport.totalDebt, 0, 'COMMA', 0, 'POINT')} + ' đ'">0 đ</td>
                        </tr>
                        <tr>
                            <th>Số NCC còn nợ:</th>
                            <td th:text="${debtReport.suppliersWithDebt}">0</td>
                        </tr>
                    </table>
                    
                    <h6 class="mt-3">Chi tiết công nợ:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                                <thead>
                                    <tr>
                                    <th>Nhà cung cấp</th>
                                    <th class="text-end">Công nợ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="supplier : ${debtReport.suppliers}">
                                    <td th:text="${supplier.name}"></td>
                                    <td class="text-end" th:text="${#numbers.formatDecimal(supplier.debt, 0, 'COMMA', 0, 'POINT')} + ' đ'"></td>
                                    </tr>
                                </tbody>
                            </table>
                    </div>
                    </div>
                </div>
            </div>
        </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script th:if="${salesReport != null && !salesReport.data.empty}">
        const revenueData = {
            labels: [
                /*[# th:each="item : ${salesReport.data}" ]*/
                /*[[ ${item.period} ]]*/,
                /*[/]*/
            ],
            datasets: [{
                label: 'Doanh thu',
                data: [
                    /*[# th:each="item : ${salesReport.data}" ]*/
                    /*[[ ${item.revenue} ]]*/,
                    /*[/]*/
                ],
                backgroundColor: 'rgba(78, 115, 223, 0.2)',
                borderColor: 'rgba(78, 115, 223, 1)',
                borderWidth: 2,
                fill: true
            }]
        };

        new Chart(document.getElementById('revenueChart'), {
            type: 'line',
            data: revenueData,
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Doanh thu: ' + new Intl.NumberFormat('vi-VN').format(context.parsed.y) + ' đ';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return new Intl.NumberFormat('vi-VN', { notation: 'compact' }).format(value);
                            }
                        }
                    }
                }
            }
        });
    </script>

    <script th:if="${inventoryReport != null}">
        new Chart(document.getElementById('inventoryChart'), {
            type: 'doughnut',
            data: {
                labels: ['Sách tồn kho', 'Sách sắp hết'],
                datasets: [{
                    data: [
                        /*[[ ${inventoryReport.totalQuantity - inventoryReport.lowStockCount} ]]*/,
                        /*[[ ${inventoryReport.lowStockCount} ]]*/
                    ],
                    backgroundColor: [
                        'rgba(28, 200, 138, 0.8)',
                        'rgba(231, 74, 59, 0.8)'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
        </script>
    </div>
</body>
</html>
